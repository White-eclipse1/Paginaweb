<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Empleos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #fafafa; }
    .card-img-top { object-fit: cover; height: 180px; }
    .badge-meta { background: #f1f3f5; color: #333; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand" href="index.html">Inicio</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="noticias.html">Noticias</a></li>
        <li class="nav-item"><a class="nav-link active" href="empleos.html">Empleos</a></li>
        <li class="nav-item"><a class="nav-link" href="contact.html">Contacto</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="py-4">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 m-0">Ofertas de trabajo</h1>
      <div class="input-group" style="max-width: 360px;">
        <span class="input-group-text">Filtrar</span>
        <input id="search" class="form-control" placeholder="puesto, modalidad, ubicaciÃ³n...">
      </div>
    </div>
    <div id="jobsList" class="row g-4"></div>
    <div class="d-flex justify-content-center my-4">
      <button id="loadMore" class="btn btn-outline-primary d-none">Cargar mÃ¡s</button>
    </div>
  </div>
</main>

<footer class="border-top py-4 bg-white">
  <div class="container small text-muted">Â© Empleos</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  // AJUSTA estos valores a tu repo si cambian
  const owner = "White-eclipse1";
  const repo = "Paginaweb";
  const branch = "main";
  const folderPath = "content/jobs";

  const pageSize = 9;
  let allItems = [];
  let filtered = [];
  let page = 0;

  async function listFiles() {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${folderPath}?ref=${branch}`);
    return res.ok ? res.json() : [];
  }

  async function fetchMarkdown(rawUrl) {
    const res = await fetch(rawUrl);
    return res.ok ? res.text() : "";
  }

  function parseFrontMatter(md) {
    if (!md.startsWith('---')) return { data:{}, body: md };
    const end = md.indexOf('\n---', 3);
    if (end === -1) return { data:{}, body: md };
    const fm = md.slice(3, end).trim();
    const body = md.slice(end + 4).trim();
    const data = {};
    fm.split('\n').forEach(line => {
      const i = line.indexOf(':');
      if (i > -1) {
        const k = line.slice(0,i).trim();
        const v = line.slice(i+1).trim().replace(/^"|"$/g,'');
        data[k] = v;
      }
    });
    return { data, body };
  }

  function card(item){
    const date = item.data.date ? new Date(item.data.date).toLocaleDateString() : "";
    const img = item.data.thumbnail ? `<img class="card-img-top" src="${item.data.thumbnail}" alt="">` : "";
    const meta = [item.data.location, item.data.modality, item.data.type].filter(Boolean).join(" â€¢ ");
    const salary = item.data.salary ? `ðŸ’° ${item.data.salary}` : "";
    const excerpt = item.body.length > 220 ? item.body.slice(0,220) + "..." : item.body;
    const apply = item.data.apply_url ? `<a class="btn btn-success btn-sm" href="${item.data.apply_url}" target="_blank" rel="noopener">Postular</a>` : "";
    return `
      <div class="col-sm-6 col-lg-4">
        <article class="card h-100 shadow-sm">
          ${img}
          <div class="card-body d-flex flex-column">
            <h3 class="h6">${item.data.title || "Puesto"}</h3>
            <div class="small text-muted mb-1">${meta}</div>
            <div class="small mb-2">${salary}</div>
            <div class="mb-3 small">${marked.parse(excerpt)}</div>
            <div class="mt-auto d-flex gap-2">
              ${apply}
              <a class="btn btn-outline-primary btn-sm" href="${item.permalink}" target="_blank" rel="noopener">Ver completo</a>
            </div>
            <div class="text-muted small mt-2">${date}</div>
          </div>
        </article>
      </div>`;
  }

  function render() {
    const start = page * pageSize;
    const slice = filtered.slice(start, start + pageSize);
    const grid = document.getElementById('jobsList');
    grid.insertAdjacentHTML('beforeend', slice.map(card).join(''));
    page++;
    const more = document.getElementById('loadMore');
    if (page * pageSize >= filtered.length) {
      more.classList.add('d-none');
    } else {
      more.classList.remove('d-none');
    }
  }

  function applySearch(q){
    const ql = q.toLowerCase();
    filtered = !q ? [...allItems] : allItems.filter(x => 
      (x.data.title || '').toLowerCase().includes(ql) ||
      (x.data.location || '').toLowerCase().includes(ql) ||
      (x.data.modality || '').toLowerCase().includes(ql) ||
      (x.data.type || '').toLowerCase().includes(ql) ||
      x.body.toLowerCase().includes(ql)
    );
    document.getElementById('jobsList').innerHTML = "";
    page = 0;
    if (!filtered.length) {
      document.getElementById('jobsList').innerHTML = "<p class='text-muted'>No hay resultados.</p>";
      document.getElementById('loadMore').classList.add('d-none');
      return;
    }
    render();
  }

  document.getElementById('search').addEventListener('input', (e)=> applySearch(e.target.value));
  document.getElementById('loadMore').addEventListener('click', render);

  (async ()=>{
    const files = await listFiles();
    const mdFiles = files.filter(f => f.name.endsWith(".md")).sort((a,b)=> a.name < b.name ? 1 : -1);
    const items = [];
    for (const f of mdFiles) {
      const raw = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${folderPath}/${encodeURIComponent(f.name)}`;
      const text = await fetchMarkdown(raw);
      const parsed = parseFrontMatter(text);
      if ((parsed.data.draft || '').toString().toLowerCase() === 'true') continue;
      items.push({ ...parsed, permalink: raw });
    }
    allItems = items;
    filtered = [...allItems];
    if (!filtered.length) {
      document.getElementById('jobsList').innerHTML = "<p class='text-muted'>Por ahora no hay vacantes.</p>";
      return;
    }
    render();
  })();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
