<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Autenticación exitosa</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: #f5f5f5;
    }
    .message {
      text-align: center;
      padding: 2rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="message">
    <h2>Procesando autenticación...</h2>
    <p id="status">Por favor espera...</p>
  </div>

<script>
(function(){
  const status = document.getElementById('status');
  
  function log(msg) {
    console.log('[Callback]', msg);
    status.textContent = msg;
  }
  
  function parseQuery(str) {
    const params = {};
    (str || '').replace(/^[#?]/, '').split('&').forEach(pair => {
      if (!pair) return;
      const [key, val] = pair.split('=');
      if (key) {
        params[decodeURIComponent(key)] = decodeURIComponent(val || '');
      }
    });
    return params;
  }

  try {
    // Parsear tanto hash como query string
    const hashParams = parseQuery(window.location.hash);
    const queryParams = parseQuery(window.location.search);
    
    console.log('Hash params:', hashParams);
    console.log('Query params:', queryParams);
    
    // Buscar el token en ambos lugares
    const token = hashParams.access_token || 
                  hashParams.token || 
                  queryParams.access_token || 
                  queryParams.token;
    
    if (!token) {
      log('❌ No se encontró el token de acceso');
      console.error('No token found in:', { hash: window.location.hash, search: window.location.search });
      setTimeout(() => {
        window.location.href = '/admin/';
      }, 2000);
      return;
    }
    
    log('✓ Token recibido, guardando...');
    
    // Guardar en localStorage con ambos nombres (compatibilidad)
    const authData = JSON.stringify({ token: token });
    localStorage.setItem('decap-cms-auth', authData);
    localStorage.setItem('netlify-cms-auth', authData);
    
    log('✓ Token guardado en localStorage');
    
    // Notificar a la ventana padre (si existe)
    if (window.opener) {
      try {
        log('✓ Notificando ventana padre...');
        window.opener.postMessage('authorization:github:success', '*');
        
        // Esperar un poco antes de cerrar
        setTimeout(() => {
          log('✓ Cerrando popup...');
          window.close();
          
          // Si no se cerró (bloqueado), redirigir
          setTimeout(() => {
            if (!window.closed) {
              log('→ Redirigiendo a /admin/...');
              window.location.href = '/admin/';
            }
          }, 500);
        }, 300);
        
      } catch (e) {
        log('⚠ Error al notificar: ' + e.message);
        setTimeout(() => window.location.href = '/admin/', 1000);
      }
    } else {
      // No hay ventana padre, redirigir directamente
      log('→ Redirigiendo a /admin/...');
      setTimeout(() => {
        window.location.href = '/admin/';
      }, 1000);
    }
    
  } catch (error) {
    log('❌ Error: ' + error.message);
    console.error('Callback error:', error);
    setTimeout(() => {
      window.location.href = '/admin/';
    }, 2000);
  }
})();
</script>
</body>
</html>
