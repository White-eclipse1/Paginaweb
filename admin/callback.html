<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Autenticación completada</title>
</head>
<body>
  <script>
    (function() {
      function getParamFrom(str) {
        const params = {};
        (str || '').replace(/^[#?]/, '').split('&').forEach(p => {
          if (!p) return;
          const [k, v] = p.split('=');
          params[decodeURIComponent(k)] = decodeURIComponent(v || '');
        });
        return params;
      }

      const hashParams = getParamFrom(location.hash);
      const queryParams = getParamFrom(location.search);
      const token =
        hashParams['access_token'] || hashParams['token'] ||
        queryParams['access_token'] || queryParams['token'];

      if (token) {
        const payload = JSON.stringify({ token });
        localStorage.setItem('netlify-cms-auth', payload);
        localStorage.setItem('decap-cms-auth', payload);

        try {
          if (window.opener && typeof window.opener.postMessage === 'function') {
            window.opener.postMessage('authorization:github:success', '*');
          }
        } catch (e) {}

        try { window.close(); } catch (e) {}
        location.replace('/admin/');
      } else {
        document.body.innerHTML = "<p>Error: No se recibió token de autenticación.</p>";
      }
    })();
  </script>
</body>
</html>
