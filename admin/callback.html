<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Autenticación completada</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: #f5f5f5;
    }
    .message {
      text-align: center;
      padding: 2rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="message">
    <div class="spinner"></div>
    <p id="status">Procesando autenticación...</p>
  </div>

  <script>
    (function() {
      const status = document.getElementById('status');
      
      function getParamFrom(str) {
        const params = {};
        (str || '').replace(/^[#?]/, '').split('&').forEach(p => {
          if (!p) return;
          const [k, v] = p.split('=');
          if (k) params[decodeURIComponent(k)] = decodeURIComponent(v || '');
        });
        return params;
      }

      // Intentar obtener token del hash o query string
      const hashParams = getParamFrom(location.hash);
      const queryParams = getParamFrom(location.search);
      const token =
        hashParams['access_token'] || hashParams['token'] ||
        queryParams['access_token'] || queryParams['token'];

      console.log('Token encontrado:', token ? 'Sí (' + token.substring(0, 10) + '...)' : 'No');

      if (token) {
        status.textContent = 'Autenticación exitosa. Completando proceso...';
        
        // Guardar en localStorage en el formato EXACTO que espera Decap CMS
        const authPayload = {
          token: token,
          provider: 'github'
        };
        
        const payloadString = JSON.stringify(authPayload);
        
        try {
          // Guardar en ambos formatos para compatibilidad
          localStorage.setItem('netlify-cms-user', payloadString);
          localStorage.setItem('decap-cms-user', payloadString);
          
          // También guardar en el formato legacy
          localStorage.setItem('netlify-cms-auth', payloadString);
          localStorage.setItem('decap-cms-auth', payloadString);
          
          console.log('✅ Token guardado en localStorage:', payloadString.substring(0, 50) + '...');
        } catch (e) {
          console.error('❌ Error guardando token:', e);
        }

        // Enviar mensaje a la ventana padre
        if (window.opener) {
          try {
            // Formato que espera Decap CMS para OAuth externo
            const authData = {
              provider: 'github',
              token: token
            };
            
            // Enviar en múltiples formatos para compatibilidad
            window.opener.postMessage(
              'authorization:github:success:' + JSON.stringify(authData),
              '*'
            );
            
            window.opener.postMessage(
              {
                type: 'authorization',
                provider: 'github', 
                status: 'success',
                token: token
              },
              '*'
            );

            console.log('✅ Mensajes enviados a ventana padre');
          } catch (e) {
            console.error('❌ Error enviando postMessage:', e);
          }

          // Intentar cerrar después de un delay
          setTimeout(() => {
            status.textContent = '¡Listo! Redirigiendo...';
            
            // En lugar de cerrar, redirigir directamente al admin
            // Esto asegura que Decap lea el token fresco del localStorage
            window.location.href = '/admin/#/collections/updates';
            
            // También intentar cerrar por si es popup
            try {
              window.close();
            } catch (e) {
              // Si no se puede cerrar, la redirección ya funcionará
            }
          }, 800);
        } else {
          // No hay ventana padre, redirigir al admin
          status.textContent = 'Redirigiendo...';
          setTimeout(() => {
            window.location.replace('/admin/');
          }, 1000);
        }
      } else {
        document.querySelector('.spinner').style.display = 'none';
        status.innerHTML = '❌ Error: No se recibió token de autenticación.<br><br>' +
          '<a href="/admin/" style="color: #3498db; text-decoration: none;">← Volver a intentar</a>';
        console.error('❌ No se encontró token en URL');
      }
    })();
  </script>
</body>
</html>