<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin | Decap CMS</title>
</head>
<body>
  <!-- 1) Carga Decap -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <!-- 2) Puente: si el popup manda el token, lo guardamos donde Decap lo busca -->
  <script>
    (function () {
      function handleAuthMessage(e) {
        if (typeof e.data !== "string") return;

        // Mensaje estándar que envía nuestro /api/callback:
        // 'authorization:github:success:<token>'
        if (e.data.startsWith("authorization:github:success:")) {
          var token = e.data.split("authorization:github:success:")[1];
          try {
            localStorage.setItem(
              "decap-cms-user",
              JSON.stringify({ token: token, provider: "github" })
            );
          } catch (err) {
            console.error("No pude guardar el token:", err);
          }
          // recarga para que Desaparezca el botón y carguen colecciones
          location.reload();
        }
      }
      window.addEventListener("message", handleAuthMessage, false);
    })();
  </script>
</body>
</html>
